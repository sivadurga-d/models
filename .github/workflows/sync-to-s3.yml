name: PROD | Uplaod & Sync

on:
  push:
    branches: ["main"]
    paths:
      - "**/*.json"
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read
  actions: write

jobs:
  validate:
    name: Validate Pricing Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout models repo
        uses: actions/checkout@v4

      - name: Validate JSON files
        run: |
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  VALIDATING PRICING CONFIGS"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          ERRORS=0
          
          for file in pricing/*.json; do
            if ! jq empty "$file" 2>/dev/null; then
              echo "‚ùå Invalid JSON: $file"
              ERRORS=$((ERRORS + 1))
            else
              echo "‚úÖ $file"
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "‚ùå Validation failed with $ERRORS error(s)"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All JSON files are valid!"

  upload-to-s3:
    name: Upload to S3
    needs: validate
    runs-on: ubuntu-latest
    environment: ENVs
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug context
        run: |
          echo "repo=$GITHUB_REPOSITORY"
          echo "ref=$GITHUB_REF"
          echo "env_name=${{ job.environment }}"
          echo "aws_region=${{ vars.AWS_REGION }}"
          echo "s3_bucket=${{ vars.S3_BUCKET }}"
          echo "s3_prefix=${{ vars.S3_PREFIX }}"

      - name: Debug role arn present
        run: |
          if [ -z "${{ secrets.AWS_ROLE_TO_ASSUME }}" ]; then
            echo "AWS_ROLE_TO_ASSUME is EMPTY (environment secret not being picked up)"
            exit 1
          fi
          echo "AWS_ROLE_TO_ASSUME is set"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Sync JSON files to S3 (only *.json)
        run: |
          aws s3 sync . "s3://${{ vars.S3_BUCKET }}/${{ vars.S3_PREFIX }}" \
            --exclude "*" \
            --include "*.json" \
            --content-type "application/json" \
            --cache-control "no-cache"

      - name: Delete removed JSONs from S3 (optional)
        if: ${{ vars.S3_DELETE_MISSING == 'true' }}
        run: |
          aws s3 sync . "s3://${{ vars.S3_BUCKET }}/${{ vars.S3_PREFIX }}" \
            --exclude "*" \
            --include "*.json" \
            --delete

  trigger-deployments:
    name: Trigger Deployments
    needs: upload-to-s3
    runs-on: ubuntu-latest
    environment: ENVs
    steps:
      - name: Generate GitHub App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: portkey-ai
          repositories: winky,gateway-enterprise-node

      - name: Trigger Winky workflow
        run: |
          echo "Triggering winky workflow with commit: ${{ github.sha }}"
          echo "Workflow: build-pricing-and-deploy.yml"
          echo "Ref: main"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ steps.app_token.outputs.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/portkey-ai/winky/actions/workflows/build-pricing-and-deploy.yml/dispatches \
            -d '{"ref":"main"}')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -eq 204 ]; then
            echo "‚úÖ Successfully triggered winky build-pricing-and-deploy workflow (production)"
          else
            echo "‚ùå Failed to trigger winky workflow. HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

      - name: List available Gateway workflows
        run: |
          echo "Listing available workflows in gateway-enterprise-node..."
          curl -s -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ steps.app_token.outputs.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/portkey-ai/gateway-enterprise-node/actions/workflows | \
            jq -r '.workflows[] | "\(.name) - \(.path)"' || echo "Failed to list workflows"

      - name: Trigger Gateway workflow
        run: |
          echo "Triggering gateway workflow with commit: ${{ github.sha }}"
          echo "Workflow: sync-and-deploy.yml"
          echo "Ref: main"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ steps.app_token.outputs.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/portkey-ai/gateway-enterprise-node/actions/workflows/sync-and-deploy.yml/dispatches \
            -d '{"ref":"main","inputs":{"source_branch":"main","source_commit":"${{ github.sha }}","triggered_by":"${{ github.actor }}"}}')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -eq 204 ]; then
            echo "‚úÖ Successfully triggered gateway sync-and-deploy workflow (production)"
          else
            echo "‚ùå Failed to trigger gateway workflow. HTTP $HTTP_CODE"
            echo "Response: $BODY"
            echo ""
            echo "üí° Tip: Check the workflow list above to find the correct workflow file name"
            exit 1
          fi
